<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Games Schedule</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="./schedule.css" />
</head>

<body>

  <div class="container">
    <header class="app-header d-flex flex-column flex-lg-row align-items-lg-center gap-2">
      <div>
        <div class="brand-title">Qualificatórias - Torneio de Robótica de Gravataí 2025</div>
        <div class="subtitle">Horários estimados — sujeito a atrasos operacionais</div>
      </div>
      <div id="ultima-atualizacao" class="last-updated ms-lg-auto"></div>
    </header>
    <div class="toolbar">
      <input type="text" id="pesquisa-time" class="form-control" placeholder="Pesquisar equipe" />
      <div class="filter-group" role="group" aria-label="Filtros de status">
        <button type="button" class="filter-btn active" data-filter="all">Todos</button>
        <button type="button" class="filter-btn" data-filter="proximos">Próximos jogos</button>
      </div>
    </div>
    <div class="legend" aria-label="Legenda de status">
      <div class="legend-item"><span class="legend-swatch"
          style="background:linear-gradient(135deg,#ffd43b,#ffa94d);"></span>Próximo</div>
      <div class="legend-item"><span class="legend-swatch"
          style="background:linear-gradient(135deg,#74c0fc,#4dabf7);"></span>Fila</div>
      <div class="legend-item"><span class="legend-swatch"
          style="background:linear-gradient(135deg,#51cf66,#2f9e44);"></span>Completo</div>
      <div class="legend-item"><span class="legend-swatch" style="background:#2c3744;"></span>Pendente</div>
    </div>
    <div class="table-wrapper mt-3">
      <table class="schedule" aria-describedby="ultima-atualizacao">
        <thead>
          <tr>
            <th scope="col">Nº</th>
            <th scope="col">Dia</th>
            <th scope="col">Horário</th>
            <th scope="col">Equipes</th>
            <th scope="col">Status</th>
          </tr>
        </thead>
        <tbody id="tabela-jogos" aria-live="polite"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal Resultados -->
  <div id="resultadoModal" class="resultado-modal" style="display:none;">
    <div class="resultado-backdrop" data-close-modal></div>
    <div class="resultado-dialog" role="dialog" aria-modal="true" aria-labelledby="resultadoTitulo">
      <button class="close-btn" data-close-modal aria-label="Fechar">×</button>
      <h2 id="resultadoTitulo" class="modal-title">Resultado do Jogo <span id="modalNumeroJogo"></span></h2>
      <div id="modalConteudo" class="modal-conteudo">
        <div class="loading">Carregando...</div>
      </div>
    </div>
  </div>

  <style>
    .resultado-modal {
      position: fixed;
      inset: 0;
      z-index: 1000;
      font-family: inherit;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0 22px;
    }

    .resultado-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, .55);
      backdrop-filter: blur(3px);
    }

    .resultado-dialog {
      position: relative;
      width: 100%;
      max-width: 1180px;
      background: #ffffff;
      color: #1f2d3d;
      padding: 1.5rem 1.75rem 2rem;
      border-radius: 1.1rem;
      box-shadow: 0 25px 50px -15px rgba(15, 23, 42, .25);
      overflow: hidden;
      transform: translate(-50%, -50%) scale(.96);
      top: 50%;
      left: 50%;
      opacity: 0;
      transition: .45s cubic-bezier(.16, .8, .24, 1);
    }

    .resultado-modal.mostrar .resultado-dialog {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }

    .resultado-backdrop {
      animation: fadeIn .4s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .close-btn {
      position: absolute;
      top: .6rem;
      right: .75rem;
      background: #e3e9ef;
      color: #334150;
      border: 0;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      font-size: 1.25rem;
      cursor: pointer;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: .25s;
    }

    .close-btn:hover {
      background: #d5dde4;
    }

    .modal-title {
      font-size: 1.05rem;
      letter-spacing: .5px;
      margin: 0 0 1rem;
      font-weight: 600;
    }

    .modal-conteudo {
      min-height: 160px;
    }

    .resultado-cards {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }

    /* Reaproveitando estilos dos cards (simplificado) */
    .res-score-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 1.1rem;
      padding: 1.2rem 1.1rem 1.1rem;
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 4px 14px -4px rgba(15, 23, 42, .12);
    }

    .res-score-card.red {
      /* Vermelho mais forte inspirado no estilo qualificatórias */
      background: linear-gradient(135deg, #ff4d5b 0%, #e3122b 55%, #b80a1e 100%);
      border-color: #e3122b;
      color: #fff;
    }

    .res-score-card.blue {
      /* Azul mais forte inspirado no estilo qualificatórias */
      background: linear-gradient(135deg, #2f8dff 0%, #0b63d6 55%, #00439f 100%);
      border-color: #0b63d6;
      color: #fff;
    }

    .res-score-card.winner {
      box-shadow: 0 0 0 3px #ffc94d, 0 0 0 6px rgba(255, 201, 77, .35), 0 16px 26px -8px rgba(0, 0, 0, .18);
    }

    .res-alliance-name {
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: .5px;
      color: #1f2d3d;
    }

    .res-score-card.red .res-alliance-name,
    .res-score-card.blue .res-alliance-name {
      color: #fff;
      text-shadow: 0 1px 2px rgba(0, 0, 0, .35);
    }

    .res-score-big {
      font-size: 3.4rem;
      font-weight: 800;
      line-height: .85;
      text-align: center;
      margin: .35rem 0 .5rem;
      color: #1a2935;
    }

    .res-score-card.red .res-score-big,
    .res-score-card.blue .res-score-big {
      color: #fff;
      text-shadow: 0 2px 4px rgba(0, 0, 0, .35);
    }

    .res-metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(46px, 1fr));
      gap: .4rem;
    }

    .res-metric-box {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: .55rem;
      padding: .4rem .32rem .34rem;
      text-align: center;
    }

    .res-metric-box span {
      display: block;
      font-size: .5rem;
      opacity: .65;
      letter-spacing: .5px;
      color: #5b6b79;
    }

    .res-metric-box strong {
      font-size: .82rem;
      font-weight: 600;
      color: #273546;
    }

    .res-score-card.red .res-metric-box,
    .res-score-card.blue .res-metric-box {
      background: rgba(255, 255, 255, .14);
      border-color: rgba(255, 255, 255, .35);
    }

    .res-score-card.red .res-metric-box span,
    .res-score-card.blue .res-metric-box span {
      color: rgba(255, 255, 255, .85);
      opacity: .85;
    }

    .res-score-card.red .res-metric-box strong,
    .res-score-card.blue .res-metric-box strong {
      color: #fff;
    }

    .res-coop-bar {
      margin-top: .75rem;
      font-size: .72rem;
      letter-spacing: .5px;
      text-transform: uppercase;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
      padding: .55rem .7rem .5rem;
      border-radius: .65rem;
      color: #425466;
    }

    .res-coop-bar.highlight {
      background: linear-gradient(135deg, #ffe8b3, #ffd77a);
      color: #3a2a00;
    }

    .res-score-card.red .res-coop-bar {
      background: linear-gradient(135deg, rgba(255, 255, 255, .18), rgba(255, 255, 255, .07));
      color: #fff;
    }

    .res-score-card.blue .res-coop-bar {
      background: linear-gradient(135deg, rgba(255, 255, 255, .18), rgba(255, 255, 255, .07));
      color: #fff;
    }

    .res-score-card.red .res-coop-bar.highlight,
    .res-score-card.blue .res-coop-bar.highlight {
      background: linear-gradient(135deg, #ffd54f, #ffb347);
      color: #3a2500;
    }

    .res-meta {
      font-size: .55rem;
      letter-spacing: .5px;
      opacity: .55;
      margin-top: .25rem;
      text-align: center;
      color: #5b6b79;
    }

    /* Pesquisa: destaque e desfoque */
    #tabela-jogos tr.search-fade {
      opacity: .65;
      filter: grayscale(.25) brightness(.97);
      transition: .25s;
    }

    #tabela-jogos tr.search-hit {
      outline: 2px solid #4dabf7;
      outline-offset: 2px;
      background: #f2f9ff;
      box-shadow: 0 0 0 3px rgba(77, 171, 247, .15);
    }

    #tabela-jogos tr.search-hit .numero-col {
      font-weight: 600;
      color: #164774;
    }

    .team-chip.chip-hit {
      background: linear-gradient(135deg, #ffd43b, #ffa94d) !important;
      color: #4a3200 !important;
      box-shadow: 0 0 0 2px rgba(255, 187, 56, .35);
    }

    #tabela-jogos tr.search-fade .team-chip {
      opacity: .85;
    }

    @media (max-width:680px) {
      .resultado-modal {
        padding: 0;
      }

      .resultado-dialog {
        top: 0;
        left: 0;
        transform: translate(0, 0);
        margin: 0;
        border-radius: 0;
        min-height: 100%;
        max-width: none;
        width: 100%;
        height: 100dvh;
        display: flex;
        flex-direction: column;
      }

      .resultado-modal.mostrar .resultado-dialog {
        transform: translate(0, 0) scale(1);
      }

      .resultado-dialog {
        padding: 1rem clamp(.9rem, 3vw, 1.25rem) 1.4rem;
      }

      .modal-conteudo {
        flex: 1;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
      }

      .resultado-cards {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .res-score-card {
        border-radius: .9rem;
      }

      .close-btn {
        top: .55rem;
        right: .6rem;
        width: 44px;
        height: 44px;
      }

      h2.modal-title {
        font-size: .95rem;
      }
    }

    @supports (padding:max(0px)) {
      .resultado-dialog {
        padding-top: max(1rem, env(safe-area-inset-top));
      }
    }
  </style>

  <script type="module">
    import { carregarSheetData } from "../sheets-to-website/sheetUtils.js";
    import { abrirResultadoJogo, inicializarResultadosSchedule } from "./resultsModal.js";

    async function atualizarTabela() {
      const agora = new Date()
      const hh = String(agora.getHours()).padStart(2, '0')
      const mm = String(agora.getMinutes()).padStart(2, '0')
      const ss = String(agora.getSeconds()).padStart(2, '0')
      const ultima = document.getElementById('ultima-atualizacao');
      if (ultima) {
        ultima.textContent = `Última atualização: ${hh}:${mm}:${ss}`;
        ultima.setAttribute('aria-live', 'polite');
      }

      const data = await carregarSheetData("https://docs.google.com/spreadsheets/d/1Dj8gcfgJWh5a1rL2cCuoEopNH9XobLSv5wWIKrNVeo8/edit?gid=70923099#gid=70923099")
      let jogosAgrupados = []
      data.forEach(jogo => {
        const num = jogo.numeroJogo
        if (!jogosAgrupados[num]) {
          jogosAgrupados[num] = {
            numeroJogo: num,
            dia: jogo.dia,
            horario: jogo.horario,
            equipes: [],
            completo: false
          }
        }
        jogosAgrupados[num].equipes.push(jogo.equipe)
      })

      const dataJogosJogados = await carregarSheetData("https://docs.google.com/spreadsheets/d/1Dj8gcfgJWh5a1rL2cCuoEopNH9XobLSv5wWIKrNVeo8/edit?gid=573412109#gid=573412109")
      const jogosJogadosMap = {}
      dataJogosJogados.forEach(item => {
        const num = item["Número de jogo "];
        if (!jogosJogadosMap[num]) jogosJogadosMap[num] = [];
        jogosJogadosMap[num].push(item);
      })

      Object.values(jogosAgrupados).forEach(jogo => {
        if (!jogo) return;
        const num = jogo.numeroJogo;
        if (jogosJogadosMap[num] && jogosJogadosMap[num].length >= 2) {
          jogo.completo = true;
          jogo.equipes = [
            jogosJogadosMap[num][0]["Equipe "],
            jogosJogadosMap[num][1]["Equipe "]
          ];
          jogo.pontosEquipe1 = jogosJogadosMap[num][0]["Pontos Individuais Equipe "];
          jogo.pontosEquipe2 = jogosJogadosMap[num][1]["Pontos Individuais Equipe "];
        }
      })

      const maiorJogoCompleto = Math.max(
        ...jogosAgrupados.filter(j => j && j.completo).map(j => j.numeroJogo)
      )

      let proximosJogosIds = []
      let entrarFilaIds = []

      console.log(maiorJogoCompleto < 0)
      if (maiorJogoCompleto < 0) {
        proximosJogosIds.push(String(1))
        entrarFilaIds.push(String(2))
      } else if (maiorJogoCompleto < 3) {
        proximosJogosIds.push(String(maiorJogoCompleto + 1))
        entrarFilaIds.push(String(maiorJogoCompleto + 2))
      } else {
        proximosJogosIds.push(String(maiorJogoCompleto + 1))
        proximosJogosIds.push(String(maiorJogoCompleto + 2))
        entrarFilaIds.push(String(maiorJogoCompleto + 3))
        entrarFilaIds.push(String(maiorJogoCompleto + 4))
        entrarFilaIds.push(String(maiorJogoCompleto + 5))
        entrarFilaIds.push(String(maiorJogoCompleto + 6))
      }

      const tbody = document.getElementById("tabela-jogos");
      tbody.innerHTML = "";
      const filtroAtivo = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';

      let jogosParaExibir = [];
      if (filtroAtivo === 'proximos') {
        // Últimos 4 jogos completos + todos os próximos (não completos)
        const jogosCompletos = jogosAgrupados.filter(j => j && j.completo).slice(-4);
        const jogosNaoCompletos = jogosAgrupados.filter(j => j && !j.completo);
        jogosParaExibir = [...jogosCompletos, ...jogosNaoCompletos];
      } else {
        // Todos os jogos
        jogosParaExibir = jogosAgrupados.filter(j => j);
      }

      jogosParaExibir.forEach(jogo => {
        let classe = "ok";
        let statusContent = '<span class="status-badge badge-pendente">Pendente</span>';
        let statusKey = 'pendente';
        if (jogo.completo) {
          classe = "completo";
          statusKey = 'completo';
          statusContent = `<button class='btn-resultado'><span>Resultado</span></button>`;
        } else if (proximosJogosIds.includes(jogo.numeroJogo)) {
          classe = "proximo-jogo pulse"; statusKey = 'proximo';
          statusContent = '<span class="status-badge badge-proximo">Próximo</span>';
        } else if (entrarFilaIds.includes(jogo.numeroJogo)) {
          classe = "entrar-fila"; statusKey = 'fila';
          statusContent = '<span class="status-badge badge-fila">Fila</span>';
        }

        const tr = document.createElement('tr');
        tr.className = classe + ' fade-in-row';
        tr.dataset.numero = jogo.numeroJogo;
        tr.dataset.status = statusKey;
        const equipesFormatadas = (() => {
          if (jogo.equipes.length === 2) {
            return `<div class=\"team-match-line\"><span class=\"team-name-lg\">${jogo.equipes[0]}</span><span class=\"vs-sep\">×</span><span class=\"team-name-lg\">${jogo.equipes[1]}</span></div>`;
          }
          return `<div class=\"team-names">${jogo.equipes.map(n => `<span class=\\"team-chip\\">${n}</span>`).join('')}</div>`;
        })();
        tr.innerHTML = `
          <td class="numero-col">${jogo.numeroJogo}</td>
          <td>${jogo.dia}</td>
          <td>${jogo.horario}</td>
          <td class="equipes-cell">${equipesFormatadas}</td>
          <td class="status-cell">${statusContent}</td>`;
        if (statusKey === 'completo') {
          tr.querySelector('.btn-resultado').dataset.numero = jogo.numeroJogo;
        }
        tbody.appendChild(tr);
      });

      const inputPesquisa = document.getElementById('pesquisa-time');
      if (inputPesquisa) {
        const valor = inputPesquisa.value.toLowerCase().trim();
        const linhas = document.querySelectorAll('#tabela-jogos tr');
        linhas.forEach(tr => {
          tr.classList.remove('search-hit', 'search-fade');
          tr.querySelectorAll('.team-chip').forEach(ch => ch.classList.remove('chip-hit'));
        });
        if (valor) {
          linhas.forEach(tr => {
            const equipesTxt = tr.querySelector('.equipes-cell')?.textContent.toLowerCase() || '';
            if (equipesTxt.includes(valor)) {
              tr.classList.add('search-hit');
              tr.querySelectorAll('.team-chip').forEach(ch => {
                if (ch.textContent.toLowerCase().includes(valor)) ch.classList.add('chip-hit');
              });
            } else {
              tr.classList.add('search-fade');
            }
          });
        }
      }
    }

    // Atualiza a tabela imediatamente e depois a cada 30s
    atualizarTabela().then(() => inicializarResultadosSchedule({
      urlPlanilhaQuali: "https://docs.google.com/spreadsheets/d/1Dj8gcfgJWh5a1rL2cCuoEopNH9XobLSv5wWIKrNVeo8/edit?gid=573412109#gid=573412109"
    }))
    setInterval(atualizarTabela, 30000)

    const inputPesquisa = document.getElementById('pesquisa-time');
    if (inputPesquisa) {
      inputPesquisa.addEventListener('input', () => atualizarTabela());
    }
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        atualizarTabela();
      });
    });

    document.addEventListener('click', e => {
      const btn = e.target.closest('.btn-resultado');
      if (btn) { abrirResultadoJogo(btn.dataset.numero); }
      if (e.target.matches('[data-close-modal]')) {
        import('./resultsModal.js').then(m => m.fecharResultadoJogo && m.fecharResultadoJogo());
      }
    });
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        import('./resultsModal.js').then(m => m.fecharResultadoJogo && m.fecharResultadoJogo());
      }
    });
  </script>
  <script type="module" src="./resultsModal.js"></script>
</body>

</html>