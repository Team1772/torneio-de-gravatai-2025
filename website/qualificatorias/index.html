<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Qualificatórias | Torneio de Robótica de Gravataí 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background: #f4f5f7;
        }

        header {
            padding-top: 1.25rem;
        }

        .score-card {
            --grad-angle: 135deg;
            border-radius: 1.25rem;
            padding: 1.5rem 1.35rem 1.25rem;
            color: #fff;
            position: relative;
            overflow: hidden;
            background: #222;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 20px -8px rgba(0, 0, 0, .35), 0 4px 8px -2px rgba(0, 0, 0, .25);
            transition: .25s ease;
        }

        .score-card:before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 78% 18%, rgba(255, 255, 255, .25), transparent 60%);
            mix-blend-mode: overlay;
            opacity: .4;
        }

        .score-card.red {
            background: linear-gradient(var(--grad-angle), #e83b4e, #b91228 68%);
        }

        .score-card.blue {
            background: linear-gradient(var(--grad-angle), #1d74ff, #0043a8 68%);
        }

        .score-card.winner {
            box-shadow: 0 0 0 3px #ffd54f, 0 0 0 6px rgba(255, 213, 79, .35), 0 16px 26px -8px rgba(0, 0, 0, .45);
            transform: translateY(-4px);
        }

        .alliance-name {
            font-size: 1.15rem;
            font-weight: 700;
            letter-spacing: .5px;
        }

        .score-big {
            font-size: 4.4rem;
            font-weight: 800;
            line-height: .85;
            text-align: center;
            width: 100%;
            filter: drop-shadow(0 4px 10px rgba(0, 0, 0, .55));
        }

        .team-meta {
            font-size: .7rem;
            letter-spacing: .5px;
            text-transform: uppercase;
            opacity: .75;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(54px, 1fr));
            gap: .4rem;
            margin-top: .5rem;
        }

        .card-body-flex {
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
        }

        .metrics-wrapper {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
        }

        .metrics-wrapper .metrics-grid {
            flex: 0 0 auto;
        }

        .metrics-wrapper .coop-bar {
            margin-top: .9rem;
        }

        .coop-bar {
            margin-top: .9rem;
            font-size: .85rem;
            letter-spacing: .6px;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #4a4a4a, #333);
            padding: .7rem .85rem .65rem;
            border-radius: .75rem;
        }

        .coop-bar.highlight {
            background: linear-gradient(135deg, #ffb347, #ffcc33);
            color: #3a2500;
        }

        .metric-box {
            background: rgba(255, 255, 255, .14);
            border-radius: .6rem;
            padding: .4rem .3rem .35rem;
            text-align: center;
        }

        .metric-box span {
            display: block;
            font-size: .55rem;
            letter-spacing: .5px;
            opacity: .75;
        }

        .metric-box strong {
            font-size: .9rem;
            font-weight: 600;
        }

        .metric-box.coop-highlight {
            background: linear-gradient(135deg, #ffb347, #ffcc33);
            color: #3a2500;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, .1), 0 4px 10px -2px rgba(0, 0, 0, .35);
        }

        .metric-box.coop-highlight span {
            opacity: .9;
        }


        .divider-col {
            width: 2px;
            background: linear-gradient(180deg, #ffffff25, #ffffff05);
            margin: 0 auto;
        }

        .score-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: .5rem 0 .35rem;
            position: relative;
        }


        .small-label {
            font-size: .65rem;
            letter-spacing: .5px;
            opacity: .7;
            text-transform: uppercase;
        }

        @media (max-width:992px) {
            .score-card {
                min-height: unset;
                padding: 1.15rem 1rem 1rem;
            }

            .score-big {
                font-size: 3.4rem;
            }

            .alliance-name {
                font-size: 1rem;
            }
        }

        @media (max-width:576px) {
            .score-big {
                font-size: 2.85rem;
            }

            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(46px, 1fr));
            }
        }
    </style>
</head>

<body>
    <header class="text-center mb-4">
        <div class="container">
            <h1 class="h4 mt-3 mb-3">Qualificatórias - Torneio de Robótica de Gravataí 2025</h1>
            <div class="d-flex gap-2 flex-wrap justify-content-center">
                <select id="selectJogo" class="form-select" style="max-width:260px" disabled>
                    <option>Carregando...</option>
                </select>
                <button id="btnBuscar" class="btn btn-primary" disabled>Buscar</button>
            </div>
            <p id="statusMsg" class="text-muted small mt-2"></p>
        </div>
    </header>
    <main class="container">
        <div class="row g-4 align-items-stretch" id="painel">
            <div class="col-12 col-lg-6">
                <div class="score-card red h-100" id="cardA">
                    <div class="card-body-flex">
                        <div class="alliance-name" id="nomeEquipeA">Equipe A</div>
                        <div class="score-wrapper">
                            <div class="score-big" id="scoreA" aria-live="polite">0</div>
                        </div>
                        <div class="team-meta" id="metaA"></div>
                        <div class="metrics-wrapper">
                            <div class="metrics-grid" id="metricsA"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6">
                <div class="score-card blue h-100" id="cardB">
                    <div class="card-body-flex">
                        <div class="alliance-name" id="nomeEquipeB">Equipe B</div>
                        <div class="score-wrapper">
                            <div class="score-big" id="scoreB" aria-live="polite">0</div>
                        </div>
                        <div class="team-meta" id="metaB"></div>
                        <div class="metrics-wrapper">
                            <div class="metrics-grid" id="metricsB"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script type="module">
        import { carregarSheetData } from "../sheets-to-website/sheetUtils.js";

        const URL_PLANILHA_QUALI = "https://docs.google.com/spreadsheets/d/1Dj8gcfgJWh5a1rL2cCuoEopNH9XobLSv5wWIKrNVeo8/edit?gid=573412109#gid=573412109";

        const selectJogo = document.getElementById('selectJogo');
        const btnBuscar = document.getElementById('btnBuscar');
        const statusMsg = document.getElementById('statusMsg');

        let rawLinhas = [];
    let jogos = {};

        function normalizarChave(str) { return (str || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim().toLowerCase(); }
        function getFlex(row, alvo) { const n = normalizarChave(alvo); for (const k of Object.keys(row)) { if (normalizarChave(k) === n) return row[k]; } }

    function parseTimestamp(ts) {
            if (!ts) return 0; const m = ts.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?/); if (!m) return 0;
            const [_, d, mo, y, h, mi, s] = m; return new Date(+y, +mo - 1, +d, +h, +mi, +(s || 0)).getTime();
        }

        function agrupar() {
            jogos = {};
            rawLinhas.forEach(r => {
                const numero = (getFlex(r, 'Número de jogo') || getFlex(r, 'Numero de jogo') || r['Número de jogo'] || r['Numero de jogo'] || '').toString().trim();
                const equipe = getFlex(r, 'Equipe') || r['Equipe'];
                if (!numero || !equipe) return;
                const bucket = (jogos[numero] || (jogos[numero] = { numero, equipes: {} }));
                const equipeKey = equipe.trim();
                const ts = parseTimestamp(getFlex(r, 'Data e Hora') || r['Data e Hora']);
                const atual = bucket.equipes[equipeKey];
                if (!atual || ts >= (atual.__ts || 0)) {
                    bucket.equipes[equipeKey] = { ...r, __ts: ts };
                }
            });
        }

        function construirMatches() {
            // Apenas jogos com exatamente 2 equipes
            const matches = {};
            Object.keys(jogos).forEach(num => {
                const nomes = Object.keys(jogos[num].equipes);
                if (nomes.length === 2) {
                    const [e1, e2] = nomes;
                    matches[num] = { numero: num, equipeA: jogos[num].equipes[e1], equipeB: jogos[num].equipes[e2] };
                }
            });
            return matches;
        }

        function extrairPontuacoes(linha) {
            function num(v) { return Number(v || 0) || 0; }
            const pN1 = num(getFlex(linha, 'pontosN1') || linha['pontosN1']);
            const pN2 = num(getFlex(linha, 'pontosN2') || linha['pontosN2']);
            const pN3 = num(getFlex(linha, 'pontosN3') || linha['pontosN3']);
            const pMov = num(getFlex(linha, 'pontosMov') || linha['pontosMov']);
            const coop = num(getFlex(linha, 'Pontos de cooperação (equipe)') || linha['Pontos de cooperação (equipe)']);
            const totalSemCoop = pN1 + pN2 + pN3 + pMov;
            const total = totalSemCoop + coop;
            return { pN1, pN2, pN3, pMov, coop, totalSemCoop, total };
        }

        function animateScore(el, novo) {
            const atual = Number(el.dataset.val || el.textContent) || 0;
            const alvo = Number(novo) || 0; if (atual === alvo) { el.textContent = alvo; return; }
            const start = performance.now(); const dur = 600;
            function step(t) { const p = Math.min(1, (t - start) / dur); const eased = 1 - Math.pow(1 - p, 3); const val = Math.round(atual + (alvo - atual) * eased); el.textContent = val; if (p < 1) requestAnimationFrame(step); else el.dataset.val = alvo; }
            requestAnimationFrame(step);
        }

        function destacar(ea, eb) {
            const cardA = document.getElementById('cardA');
            const cardB = document.getElementById('cardB');
            cardA.classList.remove('winner');
            cardB.classList.remove('winner');
            if (ea === eb) return; (ea > eb ? cardA : cardB).classList.add('winner');
        }

        function renderJogo(match) {
            // console.log('[DEBUG] Match selecionado', match); // debug opcional
            const nomeA = getFlex(match.equipeA, 'Equipe') || match.equipeA['Equipe'] || '(sem nome)';
            const nomeB = getFlex(match.equipeB, 'Equipe') || match.equipeB['Equipe'] || '(sem nome)';
            const pontA = extrairPontuacoes(match.equipeA);
            const pontB = extrairPontuacoes(match.equipeB);
            document.getElementById('nomeEquipeA').textContent = nomeA;
            document.getElementById('nomeEquipeB').textContent = nomeB;
            animateScore(document.getElementById('scoreA'), pontA.total);
            animateScore(document.getElementById('scoreB'), pontB.total);
            destacar(pontA.total, pontB.total);
            preencherMetricas('A', pontA);
            preencherMetricas('B', pontB);
            // meta removida conforme solicitação anterior (sem timestamp)
            document.getElementById('metaA').textContent = '';
            document.getElementById('metaB').textContent = '';
        }

        function preencherMetricas(prefix, pont) {
            const metricsEl = document.getElementById('metrics' + prefix);
            if (!metricsEl) return;
            metricsEl.innerHTML = '';
            const card = document.getElementById('card' + prefix);
            const wrapper = card?.querySelector('.metrics-wrapper');
            if (!wrapper) return;
            // remove coop anterior
            wrapper.querySelectorAll('.coop-bar').forEach(el => el.remove());
            const baseMetrics = [
                { label: 'N1', val: pont.pN1 },
                { label: 'N2', val: pont.pN2 },
                { label: 'N3', val: pont.pN3 },
                { label: 'Mov', val: pont.pMov }
            ];
            baseMetrics.forEach(item => {
                const div = document.createElement('div');
                div.className = 'metric-box';
                div.setAttribute('aria-label', `${item.label} ${item.val}`);
                div.innerHTML = `<span>${item.label}</span><strong>${item.val}</strong>`;
                metricsEl.appendChild(div);
            });
            const coopBar = document.createElement('div');
            coopBar.className = 'coop-bar' + (pont.coop > 0 ? ' highlight' : '');
            coopBar.innerHTML = `<span style="font-size:.9rem; font-weight:600; letter-spacing:.8px">Cooperação</span><strong class="coop-value" data-final="${pont.coop}" style="font-size:1.25rem">0</strong>`;
            wrapper.appendChild(coopBar);
            // anima coop
            animateScore(coopBar.querySelector('.coop-value'), pont.coop);
        }


        let matchesQuali = {};

        async function carregar() {
            statusMsg.textContent = 'Carregando qualificatórias...';
            try {
                rawLinhas = await carregarSheetData(URL_PLANILHA_QUALI);
                console.log('[DEBUG] Linhas carregadas quali:', rawLinhas.length);
                if (rawLinhas[0]) console.log('[DEBUG] Cabeçalhos quali:', Object.keys(rawLinhas[0]));
                agrupar();
                matchesQuali = construirMatches();
                console.log('[DEBUG] Matches construídos quali:', Object.keys(matchesQuali).length, matchesQuali);
                const numeros = Object.keys(matchesQuali).sort((a, b) => Number(a) - Number(b));
                selectJogo.innerHTML = '<option value="">Selecione o jogo</option>';
                numeros.forEach(n => { const opt = document.createElement('option'); opt.value = n; opt.textContent = n; selectJogo.appendChild(opt); });
                selectJogo.disabled = false; btnBuscar.disabled = false;
                statusMsg.textContent = numeros.length ? `${numeros.length} jogo(s) disponíveis.` : 'Nenhum jogo encontrado.';
            } catch (err) {
                statusMsg.textContent = 'Erro ao carregar: ' + err;
            }
        }

        btnBuscar.addEventListener('click', () => {
            const num = selectJogo.value; if (!num) { statusMsg.textContent = 'Selecione um jogo.'; return; }
            statusMsg.textContent = '';
            renderJogo(matchesQuali[num]);
        });

        carregar();
    </script>
</body>

</html>